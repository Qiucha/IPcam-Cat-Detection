# IPcam Cat Detection
A small side project to use old IPcam/Android phone as cat detection camera, combined with Raspberry or mac mini like power efficient computing platform.

## Prerequisites

- A computer or IoT device that is capable of handling the object detection model efficiently.

- (Optional) Docker installed on the device mentioned above, with the compose plugin. This is for self-host [ntfy](https://ntfy.sh). Other options should also be considered as well. For more detail, check out [Known Issue](#known-issues) section of this article.

- A functioning IP camera, or a functioning Android phone with IP camera app such as [IP webcam](https://play.google.com/store/apps/details?id=com.pas.webcam&hl=en) installed. I didn't research for iOS devices, but there should be some compatible options.

- An already built conda environment (or other virtual environment of choice) with packages in [requirement.txt](requirement.txt). Detailed installation guide is in [Step.1](#step1-build-virtual-environment)


## Usage
### Step.0 Clone/Download This Repo
Head to the directory your going to store all of the code of this project.

```shell
gh repo clone Qiucha/IPcam-Cat-Detection
```

or directly download through `Code > Download zip` on this page.

### Step.1 Build Virtual Environment
Here, [conda](https://www.anaconda.com/) is used as an example, use whatever the virtual environment tool you're familiar with.
```shell
conda create -n ipcd python=3.12 -y
```
After that, do:
```shell
conda activate ipcd; pip install -r requirement.txt
```
Note that this would install all the packages with specific version, if indicated, in the [requirement.txt](requirement.txt).

### Step.2 Create `.env` files in home directory of this project and `ntfy-docker` respectively.
#### (Optional/Recommended) Use [`utils/__env_gen__.py`](utils/__env_gen__.py) for creating formatted `.env` files
head to the home directory of the project in terminal and execute the following command:
```shell
python utils/__env_gen__.py
```
And don't forget to fill in the information! This script is just for formatting and project path filling!

#### Format of `.env`
```env
# webcam related information
USER=[ex: user]
PASSWORD=[ex: password1111 (should be something more secure tho...)]
URL=[ex: rtsp://192.168.1.100:8080/video0 (checkout your ipcam manufacture for detailed settings)]

# ntfy related information
NTFY_USER=[ex: user]
NTFY_PASS=[ex: password1111 (should be something more secure tho...)]
HOSTNAME=[ex: ntfy.tail-scale.ts.net]
TOPIC=[ex: asdf1234 (which should be generated by ntfy)]

# Load model for object recognition
MODEL=yolov8n.pt

# path related, if IMG_SAVE_PATH is not set, save_img would be set to PROJ_PATH/saved_img 
PROJ_PATH=[ex: /Users/user/Projects/IPcam-Cat-Detection]
IMG_SAVE_PATH=

# notification/process suspend after activation (in seconds)
SUSPEND=[ex: 900 (for 15 minutes)]
```

#### Format of `ntfy-docker/.env`
```env
# Set to your timezone, check: https://en.wikipedia.org/wiki/List_of_tz_database_time_zones
TZ=UTC 

# Set to your UID:GID, usd terminal command `id`
UID=1000
GID=1000

# base_url settings for ntfy
BASE_URL=[ex: https://ntfy.tail-scale.ts.net]

# NTFY path settings, personally recommend set to a absolute path for management
NTFY_CACHE=[ex: ./ntfy/cache]
NTFY_ETC=[ex: ./ntfy/etc]

# tailscale path settings, personally recommend set to a absolute path for management
TS_NTFY_CONFIG=[ex: ./ts/ntfy/config]
TS_NTFY_STATE=[ex: ./ts/ntfy/state]
```

### Step.3 Build Ntfy Server
Here, the process using tailscale and docker is been shown, this could be replaced with other options of your own choice. Note that here a desktop docker environment is recommended for tailscale login without a ts-authkey. Otherwise, using a authkey could be a time-saver.

#### 3.1. Setup `ntfy-docker` docker container stack
```shell
cd ntfy-docker
docker compose up -d
```
Login to your tailscale account via the link provided in ts-ntfy docker log interface. Or add your ts-authkey in the `docker-compose.yml` file by uncommenting the `TS_AUTHKEY=...` line and add your ts-auth key to it in the [`docker-compose.yaml`](ntfy-docker/docker-compose.yaml) file.

#### 3.2. Make some necessary file in `ntfy` docker container
Head to execute tab of `ntfy` docker container in docker desktop.

```shell
mkdir /var/cache/ntfy/attachments;
touch /etc/ntfy/server.yml;
vi /etc/ntfy/server.yml
```

Inside `server.yml`. Set the values shown below. Note that some values are not necessary for text-only notifications to work. For detail, check out [official docs about attachments](https://docs.ntfy.sh/publish/#attachments):

```yml
base-url: "https://ntfy.example.com"
attachment-cache-dir: "/var/cache/ntfy/attachments"
cache-file: "/var/cache/ntfy/cache.db"
attachment-total-size-limit: "5G"
attachment-file-size-limit: "15M"
attachment-expiry-duration: "3h"
visitor-attachment-total-size-limit: "100M"
visitor-attachment-daily-bandwidth-limit: "500M"
upstream-base-utl: "https://ntfy.sh"
```

> [!NOTE] 
> Note that the `base-url` value should be set to your own tailnet name, `https://ntfy.tail-scale.ts.net` for example, if using tailscale.



#### 3.3. (Optional, recommended for tailscale) Setup tailscale serve
Head to execute tab of `ts-ntfy` docker container in docker desktop.
```shell
tailscale serve --bg 80;
tailscale serve status --json >> /config/serve.json
``` 

### Step.4 Install Ntfy App on your phone
- Android: [ntfy on Google Playstore](https://play.google.com/store/apps/details?id=io.heckel.ntfy&hl=en)

- iOS: [ntfy on App Store](https://apps.apple.com/us/app/ntfy/id1625396347)

For iOS, note that some functionality limitations are identified by the auther of ntfy, which is still in progress. Check the guide in [offical known issues](https://docs.ntfy.sh/known-issues/). The PWA workaround didn't work well for me personally though.

Remember to setup your server url and user credits according to the settings above.


### Final Step. Have fun with your cat!
Play with a test cat picture with [pilot.ipynb](pilot.ipynb) or deploy the [main.py](main.py) directly!

To use [pilot.ipynb](pilot.ipynb), check out a IDE that supports jupyter notebook for better experience; To use [main.py](main.py) directly and depoly the program, head to the home directory of this project and use the following terminal command below.

```shell
conda activate ipcd
python main.py
```

To end the loop, use keyboard interruption, usually by focusing on the terminal and press `Ctrl + C`.

Or even better, use/modify this project as blueprint to suit your own needs!


## References
- [RTSP Streams to cv2](https://sandervandevelde.wordpress.com/2024/10/12/recording-rtsp-video-feeds-using-python-and-opencv/)
- [YOLO opencv eliminating artifacts in rtsp frame decoding - medium](https://blog.gopenai.com/yolo-opencv-eliminating-artifacts-in-rtsp-frame-decoding-88a9dbf47754)


## Note on Performance
Using pretrained model 'yolov8n.pt' from [ultralytic](https://docs.ultralytics.com/models/yolov8/#supported-tasks-and-modes).

### CPU Inference
Tested with mac mini M4 (16G RAM), macbook air M1 (8G RAM) and a raspberry pi 4B (8G model).

For a mostly idle mac mini M4 (16G RAM), the inference time is around **22** ms avg.

For a base macbook air M1 (8G RAM), the inference time is around **50** ms avg. Note that this machine is almost always busy running other processes.

For raspberry pi 4B (8G RAM) model, the inference time is around **850** ms. Note that this machine is also running other processes, tho not as demanding as M1 macbook air.

User could, and probably should set threshold and step according to the ability of your own device.

### GPU/MPS Inference
For a mostly idle mac mini M4 (16G RAM), the inference time is around **5.5** ms avg.

For a base macbook air M1 (8G RAM), the inference time is around **10** ms avg.


## Story behind the project
There's a cat near my parents place that my parents liked that little kitty and wanted to feed her anytime she comes by. However, she does not make any sound and this makes them hard to notice. So an idea of cat detection camera comes to our mind.

There're some existing projects which mostly use raspberry pi and raspberry pi camera to achieve this functionality, but there's a spare old IP camera in their place and they don't want to spend much when there's alternative. That's why I'm doing this project to utilize the old IP camera and the mac mini that they're barely using, but still needed for work.


## Known Issues
### iOS Ntfy compatibility issue
This is known issue to me before starting this project. Not a deal break for me personally, but definitely a point to consider. For a comprehensive read, checkout [Ntfy â€” Self-hosted push notification server for all your services](https://akashrajpurohit.com/blog/selfhost-ntfy-for-push-notifications/).
